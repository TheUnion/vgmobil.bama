var OPTIONS={FORMAT:"json",METHOD:"post",SERVER:"http://kromaviews.no:8080/dev/games/bama/srv/kroma.timetracker.php",TIMER_INTERVAL:1e3,REPORT_INTERVAL:15,MAX_DURATION:5,IDLE_TIMEOUT:60,SESSION_TIMEOUT:120},CLIENT={url:window.location.href,event:"unknown",timestamp:0,description:""};VGTouchTimeTracker=function(e,t){var i={__console:document.getElementById("console")||!1,_options:{},_client:{},_timer:!1,SESSION:{start:(new Date).getTime(),initialized:!1,expired:!1,IS_IDLE:!1,IS_VISIBLE:!0,IDLE_TICKER:0,PREV_EVENT:(new Date).getTime(),TIME:{total:0,idle:0,active:0,visible:0,hidden:0}}};return i.__getLastEventTime=function(){return this.SESSION.PREV_EVENT},i.__onWindowMessage=function(e){VGTouchTimeTracker.log(e.origin+" posted message: "+e.data)},i.__onIdleStart=function(){var e=VGTouchTimeTracker;e.SESSION.TIME.active>=e.SESSION.IDLE_TICKER&&(e.SESSION.TIME.active-=e.SESSION.IDLE_TICKER,e.SESSION.TIME.idle+=e.SESSION.IDLE_TICKER),e.SESSION.IS_IDLE=!0},i.__onIdleEnd=function(){self.SESSION.IS_IDLE=!1},i.__onVisible=function(){var e=VGTouchTimeTracker;e.SESSION.initialized&&(e.SESSION.IS_IDLE=!1),e.SESSION.IS_VISIBLE=!0},i.__onHidden=function(){var e=VGTouchTimeTracker;e.SESSION.IS_IDLE=!0,e.SESSION.IS_VISIBLE=!1},i.__onTimer=function(){var e=VGTouchTimeTracker||!1;e&&(0===e.SESSION.TIME.total%e._options.REPORT_INTERVAL&&e.update(),e.SESSION.IDLE_TICKER++,e.SESSION.TIME.total++,e.SESSION.IS_VISIBLE?e.SESSION.TIME.visible++:e.SESSION.TIME.hidden++,e.SESSION.IS_IDLE?(e.SESSION.TIME.idle++,Math.round(((new Date).getTime()-e.SESSION.PREV_EVENT)/1e3)>=e._options.SESSION_TIMEOUT&&e.stop()):e.SESSION.IS_VISIBLE&&(e.SESSION.TIME.active++,e.SESSION.IDLE_TICKER>=e._options.IDLE_TIMEOUT&&(e.SESSION.IS_IDLE=!0,e.__onIdleStart())))},i.__init=function(e,t){var i="";if(this.SESSION.initialized===!0)return!1;this.SESSION.info={animationMethod:this.getAnimationMethod(),url:t.url},document.addEventListener("message",this.__onWindowMessage,!1),document.addEventListener("focus",this.__onVisible,!1),document.addEventListener("blur",this.__onHidden,!1),i=["mousedown","keydown"],"ontouchstart"in window&&i.push("touchstart");for(var n=0;i.length>n;n++)window.addEventListener(i[n],this.onActivity,!1);for(var o in e)this._options[o]=e[o];return this._img=new Image,this.SESSION.initialized=!0,!0},i._sendJSON=function(e){var t=new XMLHttpRequest,i=JSON.stringify(e);return 0===e.length?!1:(t.onload=this._onResponse,t.open("POST",this._options.SERVER,!0),t.setRequestHeader("Content-type","application/json; charset=utf-8"),t.setRequestHeader("Content-length",i.length),t.setRequestHeader("Connection","close"),t.send(i),void 0)},i._sessionTime=function(){return this.START_SESSION-(new Date).getTime()},i._sendREQUEST=function(e){var t=this._encodeAsGet(e);this._img.src=this._options.SERVER+"?"+t},i._send=function(e,t){var t=t||this._options.METHOD;if("object"!=typeof e)return!1;if(0===e.length)return!1;switch(t.toLowerCase()){case"json":this._sendJSON(e);break;case"get":this._sendREQUEST(e);break;default:this._sendJSON(e)}},i._onResponse=function(){if(4==this.readyState){if(200!=this.status&&304!=this.status)return i.log("HTTP error: "+this.status+" - "+this.statusText),void 0;try{var e=JSON.parse(this.responseText);1==e.OK}catch(t){}}},i._onError=function(e){var t="string"==typeof e.message?e.message:!1;t&&(t+="\n"+e.fileName||"",t+=":",t+=e.lineNumber||"",t+=" - "),DEBUG&&(t+=VGTouchTimeTracker.stacktrace(e)),this.error(t,e)},i._logToConsole=function(e,t){return this.__console&&(this.__console.value+=e+("undefined"!==t?JSON.stringify(t):"")),window.console?void 0:(t?console.log(e,t):console.log(e),!0)},i.getAnimationMethod=function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};return e.name||"window.setTimeout"},i.setVisible=function(e){var e=e||!0;this.IS_VISIBLE!==e&&(this.IS_VISIBLE=e),this.IS_VISIBLE||(VGTouchTimeTracker.SESSION.IS_IDLE=!0)},i.onActivity=function(){var e=VGTouchTimeTracker;e.SESSION.PREV_EVENT=(new Date).getTime(),e.SESSION.IDLE_TICKER=0,e.SESSION.IS_IDLE=!1,e.SESSION.expired&&e.run()},i.setSessionVariable=function(e,t,i){var i="string"==typeof i&&i.length>0?i:!1;i?(this.SESSION[i]||(this.SESSION[i]={}),this.SESSION[i][e]=t):this.SESSION[e]=t},i.error=function(e,t){this._send({event:"error",message:e,data:t||!1})},i.log=function(e,t){this._send({event:"log",message:e,data:t||!1})},i.send=function(e,t){var t=t||"data";this._send({event:t,data:e||null})},i.update=function(){this.send(this.SESSION,"time")},i.stacktrace=function(e){return e.stack||"No stack trace available."},i.stop=function(){this._timer!==!1&&(this.SESSION.expired=!0,clearInterval(this._timer),this._timer=!1)},i.run=function(e){var e=e||1e3;this._timer!==!1&&(clearInterval(this._timer),this._timer=!1),this.SESSION.expired=!1,this._timer=setInterval(this.__onTimer,e)},window.onerror=this._onError,i.__init(e,t),i}(OPTIONS,CLIENT);