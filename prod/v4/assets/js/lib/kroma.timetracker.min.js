var OPTIONS={FORMAT:"json",METHOD:"post",SERVER:"http://kromaviews.no:8080/dev/games/bama/srv/kroma.timetracker.php",TIMER_INTERVAL:1e3,REPORT_INTERVAL:15,MAX_DURATION:5,IDLE_TIMEOUT:60,SESSION_TIMEOUT:120},CLIENT={url:window.location.href,event:"unknown",timestamp:0,description:""};VGTouchTimeTracker=function(e,t){var o={__console:document.getElementById("console")||!1,_options:{},_client:{},_timer:!1,SESSION:{start:(new Date).getTime(),initialized:!1,expired:!1,IS_IDLE:!1,IS_VISIBLE:!0,IDLE_TICKER:0,PREV_EVENT:(new Date).getTime(),TIME:{total:0,idle:0,active:0,visible:0,hidden:0}}};return o.__getLastEventTime=function(){return this.SESSION.PREV_EVENT},o.__onWindowMessage=function(e){VGTouchTimeTracker.log(e.origin+" posted message: "+e.data)},o.__onIdleStart=function(){var e=VGTouchTimeTracker;console.log("Now idling ... "+e.SESSION.TIME.active+"/"+e.SESSION.TIME.total),e.SESSION.TIME.active>=e.SESSION.IDLE_TICKER&&(e.SESSION.TIME.active-=e.SESSION.IDLE_TICKER,e.SESSION.TIME.idle+=e.SESSION.IDLE_TICKER),e.SESSION.IS_IDLE=!0,console.log("After correcting for idle time ... "+e.SESSION.TIME.active+"/"+e.SESSION.TIME.total)},o.__onIdleEnd=function(){self.SESSION.IS_IDLE=!1},o.__onVisible=function(){var e=VGTouchTimeTracker;e.SESSION.initialized&&(e.SESSION.IS_IDLE=!1),e.SESSION.IS_VISIBLE=!0},o.__onHidden=function(){var e=VGTouchTimeTracker;e.SESSION.IS_IDLE=!0,e.SESSION.IS_VISIBLE=!1},o.__onTimer=function(){var e=VGTouchTimeTracker||!1;return e?(0===e.SESSION.TIME.total%e._options.REPORT_INTERVAL&&(console.log("Tracking active time: "+e.SESSION.TIME.active+"/"+e.SESSION.TIME.total),e.update()),e.SESSION.IDLE_TICKER++,e.SESSION.TIME.total++,e.SESSION.IS_VISIBLE?e.SESSION.TIME.visible++:e.SESSION.TIME.hidden++,e.SESSION.IS_IDLE?(e.SESSION.TIME.idle++,Math.round(((new Date).getTime()-e.SESSION.PREV_EVENT)/1e3)>=e._options.SESSION_TIMEOUT&&e.stop()):e.SESSION.IS_VISIBLE&&(e.SESSION.TIME.active++,e.SESSION.IDLE_TICKER>=e._options.IDLE_TIMEOUT&&(console.log("IDLING after timeout: "+e.SESSION.IDLE_TICKER),e.SESSION.IS_IDLE=!0,e.__onIdleStart())),void 0):(console.log("No TimeTracker object!"),void 0)},o.__init=function(e,t){var o="";if(this.SESSION.initialized===!0)return console.log("Trying to __init() tracker object, but it is already initialized. This should never happen."),!1;this.SESSION.info={animationMethod:this.getAnimationMethod(),url:t.url},document.addEventListener("message",this.__onWindowMessage,!1),document.addEventListener("focus",this.__onVisible,!1),document.addEventListener("blur",this.__onHidden,!1),o=["mousedown","keydown"],"ontouchstart"in window&&o.push("touchstart");for(var i=0;o.length>i;i++)window.addEventListener(o[i],this.onActivity,!1);for(var n in e)this._options[n]=e[n];return this._img=new Image,this.SESSION.initialized=!0,!0},o._sendJSON=function(e){var t=new XMLHttpRequest,o=JSON.stringify(e);return 0===e.length?(console.log("NOT sending empty data object to logging server."),!1):(t.onload=this._onResponse,t.open("POST",this._options.SERVER,!0),t.setRequestHeader("Content-type","application/json; charset=utf-8"),t.setRequestHeader("Content-length",o.length),t.setRequestHeader("Connection","close"),t.send(o),void 0)},o._sessionTime=function(){return this.START_SESSION-(new Date).getTime()},o._sendREQUEST=function(e){var t=this._encodeAsGet(e);console.log("Sending GET request: "+this._options.SERVER+"?"+t),this._img.src=this._options.SERVER+"?"+t},o._send=function(e,t){var t=t||this._options.METHOD;if("object"!=typeof e)return console.log("Wrong parameter type '"+typeof e+"', expected 'object'."),!1;if(0===e.length)return console.log("NOT sending empty data object to logging server."),!1;switch(t.toLowerCase()){case"json":this._sendJSON(e);break;case"get":this._sendREQUEST(e);break;default:this._sendJSON(e)}},o._onResponse=function(e){if(4==this.readyState){if(200!=this.status&&304!=this.status)return o.log("HTTP error: "+this.status+" - "+this.statusText),void 0;try{var t=JSON.parse(this.responseText);1==t.OK||console.log("Error-response received from logger service: "+this.status+"; OK: "+t.OK,t)}catch(e){console.log("Error: ",e)}}},o._onError=function(e){var t="string"==typeof e.message?e.message:!1;t&&(t+="\n"+e.fileName||"",t+=":",t+=e.lineNumber||"",t+=" - "),DEBUG&&(t+=VGTouchTimeTracker.stacktrace(e)),this.error(t,e)},o._logToConsole=function(e,t){return this.__console?(console.log("console.nodeName: "+this.__console.nodeName),console.log("console.nodeType: "+this.__console.nodeType),this.__console.value+=e+("undefined"!==t?JSON.stringify(t):"")):console.log("No __console element!"),window.console?void 0:(t?console.log(e,t):console.log(e),!0)},o.getAnimationMethod=function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};return e.name||"window.setTimeout"},o.setVisible=function(e){var e=e||!0;this.IS_VISIBLE!==e&&(this.IS_VISIBLE=e),this.IS_VISIBLE||(VGTouchTimeTracker.SESSION.IS_IDLE=!0)},o.onActivity=function(){var e=VGTouchTimeTracker;e.SESSION.PREV_EVENT=(new Date).getTime(),e.SESSION.IDLE_TICKER=0,e.SESSION.IS_IDLE=!1,e.SESSION.expired&&(console.log("restarting expired session: "+e.SESSION.start),e.run())},o.setSessionVariable=function(e,t,o){var o="string"==typeof o&&o.length>0?o:!1;o?(this.SESSION[o]||(this.SESSION[o]={}),this.SESSION[o][e]=t):this.SESSION[e]=t},o.error=function(e,t){this._send({event:"error",message:e,data:t||!1})},o.log=function(e,t){this._send({event:"log",message:e,data:t||!1})},o.send=function(e,t){var t=t||"data";this._send({event:t,data:e||null})},o.update=function(){this.send(this.SESSION,"time")},o.stacktrace=function(e){return e.stack||"No stack trace available."},o.stop=function(){this._timer!==!1&&(this.SESSION.expired=!0,console.log("Stopping time tracker: "+this._timer),clearInterval(this._timer),this._timer=!1)},o.run=function(e){var e=e||1e3;this._timer!==!1&&(clearInterval(this._timer),this._timer=!1),this.SESSION.expired=!1,console.log("(re)starting time-tracker's timer"),this._timer=setInterval(this.__onTimer,e)},window.onerror=this._onError,console.log("Starting VGTouchTimeTracker."),o.__init(e,t),o}(OPTIONS,CLIENT);