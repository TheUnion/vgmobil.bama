<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Views: VGMobil.Bama -> Nyt Norge</title>
  <link rel="stylesheet" type="text/css" href="assets/css/main.css" />
</head>
<body>

<div>
  <table id="report">
    <thead class="tableheader">
      <tr id="reportheaders">
      </tr>
    </thead>
    <tbody id="reportbody" class="tablebody">
      <!-- <tr><td>123544536</td><td>120</td><td>120</td><td>120</td><td>120</td><td>122.5364.654.4</td><td>15:54 03.07.2013</td></tr> -->
    </tbody>
  </table>

  <table id="sessions">
    <thead class="tableheader">
      <tr id="sessionheaders"></tr>
    </thead>
    <tbody id="sessionbody" class="tablebody">
    </tbody>
  </table>
</div>


<div id="console">

</div>

<script>
 
  var 
    DataSet = {

      __updates   : [],
      __summary   : document.getElementById('reportbody') || false,
      __sessions  : document.getElementById('sessionbody') || false,
      __rowElems  : null,
      __rows      : [],
      __rowIndex  : {},
      _hasHeaders : false,


      __updateTable : function () {
        if (!this.__summary) { 
          return false;
        }

      },

      __refreshTable : function () {
        if (!this.__summary) { 
          return false;
        }

      },


      __setHeaders : function (obj) {
        var
          headerRow = document.getElementById('sessionheaders') || false,
          tdList    = document.createDocumentFragment(),
          cell      = null;

        if(!headerRow) {
          console.log("No sessionheaders table row found");
          return false;
        }

        for(var key in obj) {
          cell = document.createElement('td');
          cell.appendChild(document.createTextNode(key));
          tdList.appendChild(cell);
          console.log("Adding header: " + key);
        }

        // append any TDs
        if(tdList.childNodes.length >0) {
          console.log("Adding " + tdList.childNodes.length + " TDs");
          headerRow.appendChild(tdList);
          return true;
        }
        else {
          console.log("No TDs added to headers");
          return false;
        }

      },


      __init : function (options) {

        // returns a live list of DOM elements, which updates as the DOM changes (i.e. no need to call more than once)
        this.__rowElems = this.__summary.getElementsByTagName('tr');
        return true;
      },


      updateRow : function (row) {
        var
          row     = (typeof row === "string") ? (JSON.parse(row) || false) : (row || false),
          rowElem = (this.__rowIndex["r"+row.start]) ? this.__rowIndex["r"+row.start]['element'] : false,
          cells   = null;

        if(row) {
          console.log("Converting row to object: ", row);
          row = this.__rowToObject(row);
          console.log("After conversion: ", row);

          rowElem = (this.__rowIndex["r"+row.start]) ? this.__rowIndex["r"+row.start]['element'] : false;
        }

        if(!rowElem) {
          console.log("NEW session: " + "r"+row.start);
          return this._addRow(row);
        }

        cells = rowElem.element.getElementsByTagName('td');

        var
          cellCount = cells.length;

        for (var i = 0; i<cellCount; i++) {
          console.log(cells[i]);
        }
        return true;
      },


      __rowToObject : function (row) {
        var
          result = {};

        for (var key in row) {
          if ( (typeof row[key] === "object")  && (typeof result[key] === "undefined") ) {
              var 
                deep = this.__rowToObject(row[key]);
              for(var idx in deep) {
                result[idx] = deep[idx];
              }
          }
          else {
            result[key] = row[key];
          }
        }
        return result;
      },


      _addRow : function (row) {
        var
          cell      = null,
          trow      = document.createElement('tr'),
          fragment  = document.createDocumentFragment();

        for( var idx in row ) {
          if(idx==="element") {
            continue;
          }
          cell = document.createElement('td');
          cell.appendChild(document.createTextNode(row[idx]));
          trow.appendChild(cell);
        }

        if( !this._hasHeaders && (trow.childNodes.length > 0) ) {
          console.log("Setting headers: " + trow.childNodes.length);
          this._hasHeaders = this.__setHeaders(row);
        }
        else {
          console.log("NOT setting headers: " + this._hasHeaders + ", " + trow.length);
        }

        fragment.appendChild(trow);
        this.__sessions.appendChild(fragment);
      },


      addRow  : function (row) {
        var
          row = (typeof row === "string") ? (JSON.parse(row) || false) : (row || false);



        if(row) {
          row = this.__rowToObject(row);
        }

        if( typeof row !== "object" ) {
          console.log("row is not an object: " + row);
          return false;
        }

        if(this.__rowIndex["r" + row.start]) {
          console.log("Row r" + row.start + " already exists, updating ...");

          return this.updateRow(row);
        }

        this.__rowIndex["r" + row.start] = this.__rows.push(row)-1;
        this._addRow(row);
      },


      deleteRow : function (idx) {
        var 
          i     = this.__rows.length,
          rows  = this.__rows;

        if(typeof idx !== "number") {
          return false;
        }

        while (i--) {
          if (rows[i] == idx) { 
            rows = rows.splice(i, 1);
            return true;
          }
        }

        return false;
      },


      findRow : function (search) {

      },


      run : function (options) {
        return this.__init(options);
      }

    };
  </script>

  <script>


    function connectionOpen(open) {
      var
        msg   = open ? "Active connection to server." : "Connection dropped, trying to reopen.",
        event = open ? "open" : "error",
        term  = document.getElementById('console') || false;

        if(!term) {
          console.log("Error: No console div");
          return;
        }

        onMessage({event: event, data: { message: msg}});
        console.log("EventSource " + event + ": ", msg);
        term.innerHTML += "EventSource " + event + ": " + msg + '<br />';
    }


    function updateConnections(event) {
      connections.innerHTML = event.data;
    }


    function updateRequests(event) {
      requests.innerHTML = event.data;
    }


    function onData(e) {
      var
        chunk = (typeof e.data === "object") ? e.data : JSON.parse(e.data);
      
      // onMessage(e);
      DataSet.addRow(chunk);
    }


    function onMessage(e) {
      var 
        term  = document.getElementById('console') || false,
        json  = typeof e.data === "object" ? e.data : JSON.parse(e.data);

      if(!term) {
        console.log("Error: No console div");
        return;
      }

      console.log("event: " + json.event);
      console.log("data : " + JSON.stringify(json.data));
      term.innerHTML += "[" + json.event + "] " + JSON.stringify(json.data) + '<br />';
    };


    function onReportData(e) {
      console.log("onReportData: ", e.data);
    }


    var 
      source  = new EventSource('../../srv/kroma.pubsub.listener.sse.php'),
      term    = document.getElementById('console') || false;


    source.addEventListener('open', function () { connectionOpen(true); }, false);
    source.addEventListener('error', function () { connectionOpen(false); }, false);
    source.addEventListener('connections', updateConnections, false);
    source.addEventListener('requests', updateRequests, false);
    source.addEventListener('time', function (e) { console.log("time: " + e.data); }, false);
    source.addEventListener('data', onData, false);
    source.addEventListener('report', onReportData, false);
    source.addEventListener('message', onMessage, false);
    source.addEventListener('update', function(e) {
      var data = JSON.parse(e.data);
      console.log('data is now ', data);
    }, false);


  </script>
</body>
</html>

